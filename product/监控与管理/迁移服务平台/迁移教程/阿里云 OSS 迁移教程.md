
## 全托管公网迁移模式
###  操作场景
全托管公网迁移模式中，无需自主部署 Agent，任务创建之后自动化执行。MSP 将通过公网拉取源站的数据保存到腾讯云对象存储，源对象存储会产生出流量费用，具体费用需要参考源存储云厂商的定价。

下文将详细介绍当源对象存储部署在阿里云OSS时，如何配置全托管公网迁移任务。

### 前提条件

#### 阿里云对象存储 OSS
创建 RAM 子账号并授予相关权限：
1.	登录 RAM 控制台。
2.	选择人员管理 > 用户 > 新建用户。
3.	勾选控制台密码登录和编程访问，之后填写用户账号信息。
4.	保存生成的账号、密码、AccessKeyID 和 AccessKeySecret。
5.	勾选用户登录名称，单击添加权限，授予子账号存储空间读写权限（AliyunOSSFullAccess）。

#### 腾讯云对象存储 COS
创建目标存储空间：用于存放迁移的数据。详情请参见 [创建存储桶]()。
创建用于迁移的子用户并授予相关权限：
1.	登陆腾讯云控制台。
2.	搜索 访问管理 或单击账户 > 访问管理 进入访问管理界面。
3.	选择【用户】>【用户列表】>【新建用户】，进入新建用户界面。
4.	新建子用户，并勾选编程访问及腾讯云控制台访问。
5.	搜索 MSP，并勾选 QcloudCOSAccessForMSPRole 及 QcloudCOSFullAccess 策略。
6.	完成子用户创建并保存生成的密码，SecretId，SecretKey。

>?迁移服务也可以使用主账号操作，但是出于安全考虑，建议新建子账号并使用子账号API密钥进行迁移，迁移完成后删除。

### 操作步骤

#### 登录迁移服务平台
1.	登录 [迁移服务平台](https://console.cloud.tencent.com/msp) ，进入迁移工具页面。
2.	找到【文件迁移工具】模块，单击【立即使用】，进入文件迁移工具配置页面。

#### 新建迁移任务
1.	在文件迁移工具配置页面，单击【新建任务】，进入新任务配置界面，进行迁移参数的设置。
2.	设置迁移任务名称。
任务名称：字符长度为1至60个字符，允许的字符为中文、英文、0-9、\_、-。此处设置的名称，将用于在任务列表中查看迁移状态和迁移进度。
3.	设置要迁移的文件来源。
此处迁移源服务提供商应选择阿里云 OSS，并在下方 AccessKey，SecretKey 文本框中输入用于迁移的云 API 密钥。源对象存储桶列表可在填入密钥后点击下拉框右侧刷新按钮获取。
![](https://main.qcloudimg.com/raw/a725306f7aa707d8953d4fd2a2038536.jpg)
4.	选择文件存储方式。
根据迁移的需求，设定迁移后文件的存储方式，可以选择：标准存储、低频存储、保持原存储属性。
 ![](https://main.qcloudimg.com/raw/efc73c00d01e17ebe4fd91fdbc9019e7.jpg)
5.	选择 Header 设置。
如果源桶中的文件设定了 Header/Tag 并且需要在迁移后保留，请选择保留或设置替换规则。
![](https://main.qcloudimg.com/raw/c1b0fea0ea17338e4f99b7f198fe6896.jpg)
6.	设定迁移规则。
选择对指定桶中的全部文件进行迁移，或仅迁移指定前缀的文件。
7.	指定迁移任务的开始时间。
如需在指定时间开始迁移，开启此开关并设定开始时间。
8.	设定最高并发数。
各公有云厂商的对象存储都有最高并发限制。为确保业务稳定，请在迁移前与源厂商（阿里云 OSS）确认并设置最高迁移可用 QPS。
![](https://main.qcloudimg.com/raw/e4d60ebd3ab102df23193465fa8125df.jpg)
9.	选择要迁移到的目标位置。
在迁移目标信息中，输入用于迁移的子用户 API 密钥。目标对象存储桶列表可在填入密钥后点击下拉框右侧刷新按钮获取。
![](https://main.qcloudimg.com/raw/e3ba7e4df47cd4db867cd2e5b8a1e9d7.jpg)
10.	指定迁移到目标桶的指定目录。
 - 保存到根目录： 直接将源桶中的文件按原始相对路径保存到目标桶的根目录。
 - 保存到指定目录：将源桶中的文件保持原始相对路径保存到指定目录中。
 ![](https://main.qcloudimg.com/raw/6140d72ef3af1be40b9ae31e5d03d627.jpg)
例如：
源桶中的文件`/a.txt`，`/dir/b.txt`两个文件，文本框中填写“dest”，那么迁移后这两个文件在目标桶中的路径为：`/dest/a.txt`，`/dest/dir/b.txt`。
如果文本框中填写`dest/20180901`，那么迁移后这两个文件在目标桶中的路径为：`/dest/20180901/a.txt`，`/dest/20180901/dir/b.txt`。
11.	选择迁移模式。
 - 新建迁移任务后立即启动全托管迁移：选择托管迁移，用户单击“新建并启动”后 MSP 服务将通过公网访问源存储进行迁移。
 - 新建迁移任务后手动下载 Agent 启动迁移：选择 Agent 模式迁移，用户在单击“新建并启动”后，将仅创建任务配置，需要用户手动下载 Agent 在迁移源一侧的服务器上部署之后才会正式启动迁移。Agent 模式适用于已有专线希望通过专线迁移的场景。
 ![](https://main.qcloudimg.com/raw/09dd0517e9dc4d9857850aaa803c4bc3.jpg)
4. 查看迁移状态和进度
在文件迁移工具主界面中，可以查看所有文件迁移任务的状态和进度：
•	“任务完成”状态，绿色是任务完成并且所有文件都迁移成功，黄色是迁移任务完成但部分文件迁移失败。
•	单击“重试失败任务”链接后，该任务中失败的文件将会重试迁移，已经成功迁移的文件不会重传。
•	单击“导出”链接可以导出迁移过程中失败的文件列表。
5. 预估文件迁移时间
迁移速度由迁移过程中涉及到的每一个环节的最低速度决定，同时受到网络传输速度和最大并发数影响。影响因素有：
影响因素	说明
迁出源的读取速度	数据源的读取速度因不同的服务商而不同，通常：
传输速度在50Mbps - 200Mbps之间。
文件读取并发在500 - 3000之间（大量小文件的传输受并发限制）。
MSP 平台的传输速度	MSP 平台提供最大200Mbps的迁移带宽。
迁入目标位置的写入速度	腾讯云对象存储 COS：写入传输速度200Mbps，写入并发500 - 800之间。
整体迁移速度会是6MByte - 25MByte（即21GB/小时 - 87GB/小时）之间。

>!若迁移过程中对象（文件）内容有变化，需要进行二次迁移。









## Agent 半托管迁移
### 操作场景
Agent 半托管迁移模式中，用户需要手工在源数据云厂商的服务上部署 Agent，Agent 通过内网拉取源数据，并推送到腾讯云对象存储 COS。
如果源数据厂商与腾讯云 COS 间已经拉通专线，Agent 半托管迁移模式不会产生出流量费用，因此建议已经部署了专线的用户采用此模式进行迁移。
本文将详细介绍当源对象存储部署在阿里云OSS时，如何配置 Agent 半托管迁移任务。
2. 准备工作
阿里云对象存储OSS
	专线准备确认：
Agent 半托管模式如果是通过专线迁移，需要确保阿里云侧主机上使用的 COS SDK，可经过专线访问 COS，迁移前请与商务经理确认。
	创建 RAM 子账号并授予相关权限：
1.	登录RAM 控制台。
2.	单击人员管理 > 用户 > 新建用户。
3.	勾选控制台密码登录和编程访问，之后填写用户账号信息。
4.	保存生成的账号、密码、AccessKeyID 和 AccessKeySecret。
5.	勾选用户登录名称，单击添加权限，授予子账号存储空间读写权限（AliyunOSSFullAccess）。

腾讯云对象存储 COS
	创建目标存储空间：
创建目标存储空间，用于存放迁移的数据。详情请参见创建存储桶。
	创建用于迁移的子用户并授予相关权限：
1.	登陆腾讯云控制台。
2.	搜索 访问管理 或单击账户 > 访问管理 进入访问管理界面。
3.	点击 用户 > 用户列表 > 新建用户 进入新建用户界面。
4.	新建子用户，并勾选编程访问及腾讯云控制台访问。
5.	搜索MSP并勾选QcloudCOSAccessForMSPRole及QcloudCOSFullAccess策
6.	完成子用户创建并保存生成的密码，SecretId，SecretKey。
	单击 这里 下载 Agent。
3. 迁移限速
MSP 迁移工具提供了限制 QPS（对象存储模式）和带宽限速（URL 列表模式）。用户在使用 Agent 迁移的情况下，也可以在迁移服务器上进行限速操作，同时在 MSP 中创建任务时选择“不限速”。
1.	执行如下命令，查看网卡序列号。
[root@VM_10_12_centos ~]# ifconfig
2.	执行如下命令，测试限速前的下载速度。
[root@VM_10_12_centos ~]# wget https://msp-test-src-1200000000.cos.ap-guangzhou.myqcloud.com/bkce_src-5.0.2.tar.gz
3.	执行如下命令，安装 iproute 工具（默认 Centos 7.x 已安装，此步可跳过）。
[root@VM_10_12_centos ~]# yum -y install iproute
4.	执行如下命令，将 eth0 网卡限速为50kbit。
[root@VM_10_12_centos ~]# /sbin/tc qdisc add dev eth0 root tbf rate 50kbit latency 50ms burst 1000
说明：
	eth0 为网卡序号，由第1步查看网卡获取。
	如果需要限速10M，则将50kbit改为10Mbit。
5.	限速后测试，执行如下命令，验证下载速度是否已被限制。
[root@VM_10_12_centos ~]# wget https://msp-test-src-1200000000.cos.ap-guangzhou.myqcloud.com/bkce_src-5.0.2.tar.gz
6.	若您需要解除限速，则可以执行如下命令，即可解除限速。
[root@VM_10_12_centos ~]# /sbin/tc qdisc del dev eth0 root tbf
4. 实施迁移
1.	在迁移源一侧建立用于迁移的临时服务器（主控服务器）。
因为建立迁移任务时需要填写 Agent 主控服务器的 IP 地址（内网 IP 地址，用于与迁移集群中的 Worker 服务器通信），因此在建立迁移任务之前，需先在阿里云上准备一台操作系统为 CentOS 7.x 64位的云服务器。
2.	在腾讯云 MSP 中建立迁移任务。
i.	在“选择迁移模式”中的“模式选择”部分，选择“新建迁移任务后手动下载 Agent 启动迁移”。
ii.	在“主节点内网 IP”部分，填写阿里云上创建的服务器内网 IP 地址（例如：172.XXX.XXX.94）。
iii.	在“OSS内网EndPoint”部分，填写阿里云对象存储桶的“EndPoint（地域节点）”。
 
3.	所有参数填写完毕后，单击【新建并启动】。需要注意的是，在 Agent 模式下，此时任务虽已创建成功但并未运行，需要按以下步骤在阿里云主控服务器上手工启动 Agent。
4.	在主控服务器上部署和启动 Agent。
i.	解压 Agent 工具包（目录无特殊要求）。
ii.	修改配置文件。
./agent/conf/agent.toml
# 此处填写腾讯云用于迁移的云 API 密钥对
secret_id = '此处填写腾讯云 API 密钥 AccessKey'
secret_key = '此处填写腾讯云 API 密钥 SecretKey'
iii.	启动 Agent。
# chmod +x ./agent/bin/agent
# cd agent/bin  //必须在 bin 目录中启动 agent 程序（否则会找不到配置文件）
#./agent
Agent 会定时自动从 MSP 平台获取任务的详细配置信息，如果创建多个迁移任务无需重复启动 Agent。
5.	扩充迁移集群（增加 Worker 服务器）。
Agent 模式支持分布式迁移（多服务器协同），如果希望进一步提高迁移速度，在有可用带宽的情况下可以增加 Worker 服务器加入到迁移：
	Worker 服务器必须与 master 服务器互通。
	如果使用专线迁移，需要确保 Worker 服务器可通过专线直接访问 COS。
Worker 服务器可以是任意配置，但建议与 master 保持一致。部署和启动 Agent 的方式与 master 服务器完全相同（同样需要修改 agent.toml 中的 secret_id 和 secret_key），因新建任务的时候已经指定了 master 服务器，新加入的 agent 均被作为 Worker 节点与 master 服务器通信获得任务。
Worker 服务器可以随时加入迁移集群，但建议创建任务之前将所有的 Worker 服务器与 master 一同创建并配置和启动 Agent，以便 master 启动任务时可以更有效的进行分片调度。
5. 查看迁移状态和进度
在文件迁移工具主界面中，可以查看所有文件迁移任务的状态和进度：
•	“任务完成”状态，绿色是任务完成并且所有文件都迁移成功，黄色是迁移任务完成但部分文件迁移失败。
•	单击“重试失败任务”链接后，该任务中失败的文件将会重试迁移，已经成功迁移的文件不会重传。
•	单击“导出”链接可以导出迁移过程中失败的文件列表。
6. 预估文件迁移时间
迁移速度由迁移过程中涉及到的每一个环节的最低速度决定，同时受到网络传输速度和最大并发数影响。影响因素有：
影响因素	说明
迁出源的读取速度	数据源的读取速度因不同的服务商而不同，通常：
传输速度在50Mbps - 200Mbps之间。
文件读取并发在500 - 3000之间（大量小文件的传输受并发限制）。
专线带宽	在接入点间的数据传输速度取决于开通的专线带宽。
迁入目标位置的写入速度	腾讯云对象存储 COS：写入传输速度200Mbps，写入并发500 - 800之间。
整体迁移速度会是6MByte - 25MByte（即21GB/小时 - 87GB/小时）之间。



>若迁移过程中对象（文件）内容有变化，需要进行二次迁移!

